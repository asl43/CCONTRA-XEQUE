<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ContraCheque AI - An√°lise Inteligente</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Darker+Grotesque:wght@300;400;500;600;700;800&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --primary: #0a4d3c;
  --primary-light: #0f6b52;
  --primary-dark: #073528;
  --accent: #e8b931;
  --accent-hover: #d4a420;
  --bg: #fafaf9;
  --surface: #ffffff;
  --surface-alt: #f5f5f4;
  --text: #1c1c1c;
  --text-muted: #6b7280;
  --border: #e5e7eb;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --info: #3b82f6;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}
/* Adicionar ap√≥s as vari√°veis :root existentes */

[data-theme="dark"] {
  --primary: #10b981;
  --primary-light: #34d399;
  --primary-dark: #059669;
  --accent: #fbbf24;
  --accent-hover: #f59e0b;
  --bg: #0f172a;
  --surface: #1e293b;
  --surface-alt: #334155;
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --border: #475569;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
}

.theme-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--surface);
  border: 2px solid var(--border);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 1.5rem;
  transition: all 0.3s ease;
  z-index: 1000;
  box-shadow: var(--shadow);
}

.theme-toggle:hover {
  transform: scale(1.1);
  box-shadow: var(--shadow-lg);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Darker Grotesque', sans-serif;
  background: linear-gradient(135deg, #fafaf9 0%, #f5f5f4 100%);
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
  padding: 20px;
}

.container { max-width: 1400px; margin: 0 auto; }

.header {
  text-align: center;
  margin-bottom: 40px;
  padding: 40px 20px;
  background: var(--surface);
  border-radius: 20px;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, var(--primary), var(--accent));
}

.header h1 {
  font-size: clamp(2rem, 5vw, 3.5rem);
  font-weight: 800;
  color: var(--primary);
  margin-bottom: 10px;
  letter-spacing: -0.02em;
}

.header .subtitle {
  font-size: 1.25rem;
  color: var(--text-muted);
  font-weight: 400;
}

.status-sync {
  margin-top: 15px;
  padding: 10px 20px;
  background: var(--surface-alt);
  border-radius: 8px;
  font-size: 0.9rem;
  color: var(--text-muted);
  display: inline-block;
}

.status-sync.synced { background: #d1fae5; color: #065f46; }
.status-sync.error { background: #fee2e2; color: #991b1b; }

.grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 30px;
  margin-bottom: 30px;
}

@media (min-width: 1024px) {
  .grid { grid-template-columns: 1fr 1fr; }
}

.card {
  background: var(--surface);
  border-radius: 16px;
  padding: 30px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  transition: all 0.3s ease;
}

.card:hover {
  box-shadow: var(--shadow-lg);
  transform: translateY(-2px);
}

.card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--border);
}

.card-icon { font-size: 2rem; filter: grayscale(0.3); }

.card-title {
  font-size: 1.75rem;
  font-weight: 700;
  color: var(--primary);
  letter-spacing: -0.01em;
}

.upload-area {
  border: 3px dashed var(--border);
  border-radius: 12px;
  padding: 40px 20px;
  text-align: center;
  background: var(--surface-alt);
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.upload-area:hover {
  border-color: var(--primary);
  background: var(--surface);
}

.upload-area.dragover {
  border-color: var(--accent);
  background: var(--primary);
  background-opacity: 0.05;
}

.upload-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.6; }
.upload-text { font-size: 1.125rem; color: var(--text-muted); margin-bottom: 12px; }
.upload-hint { font-size: 0.875rem; color: var(--text-muted); font-family: 'IBM Plex Mono', monospace; }

input[type="file"] {
  position: absolute;
  opacity: 0;
  width: 100%;
  height: 100%;
  cursor: pointer;
  top: 0;
  left: 0;
}

.form-group { margin-bottom: 20px; }

.form-label {
  display: block;
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-family: 'IBM Plex Mono', monospace;
}

.input-wrapper { position: relative; }

.input-prefix {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--text-muted);
  font-weight: 600;
  font-family: 'IBM Plex Mono', monospace;
}

input[type="text"],
input[type="number"],
input[type="month"],
textarea,
select {
  width: 100%;
  padding: 14px 14px 14px 40px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 1.125rem;
  font-family: 'IBM Plex Mono', monospace;
  font-weight: 500;
  transition: all 0.2s ease;
  background: var(--surface);
}

input[type="month"] { padding: 14px; }
select { padding: 14px; cursor: pointer; }

input:focus,
textarea:focus,
select:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(10, 77, 60, 0.1);
}

textarea {
  padding: 14px;
  min-height: 140px;
  resize: vertical;
  font-size: 0.95rem;
  line-height: 1.6;
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: 10px;
  padding: 16px 32px;
  border: none;
  border-radius: 12px;
  font-size: 1.125rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  font-family: 'Darker Grotesque', sans-serif;
  box-shadow: var(--shadow);
}

.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.btn-accent { background: var(--accent); color: var(--primary-dark); }
.btn-accent:hover { background: var(--accent-hover); transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.btn-info { background: var(--info); color: white; }
.btn-info:hover { background: #2563eb; transform: translateY(-2px); box-shadow: var(--shadow-lg); }
.btn-full { width: 100%; justify-content: center; }
.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

.historico-container {
  background: var(--surface);
  border-radius: 16px;
  padding: 30px;
  box-shadow: var(--shadow);
  border: 1px solid var(--border);
  margin-bottom: 30px;
}

.filtros-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
  padding: 20px;
  background: var(--surface-alt);
  border-radius: 12px;
}

.historico-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  font-family: 'IBM Plex Mono', monospace;
}

.historico-table th {
  text-align: left;
  padding: 12px;
  background: var(--primary-dark);
  color: white;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.875rem;
  letter-spacing: 0.05em;
  position: sticky;
  top: 0;
}

.historico-table td { padding: 12px; border-bottom: 1px solid var(--border); }
.historico-table tr:hover { background: var(--surface-alt); cursor: pointer; }
.historico-table .amount { text-align: right; font-weight: 600; font-size: 1.05rem; }

.badge {
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
}

.badge-success { background: #d1fae5; color: #065f46; }
.badge-warning { background: #fef3c7; color: #92400e; }
.badge-danger { background: #fee2e2; color: #991b1b; }

.progress-container {
  margin: 20px 0;
  padding: 20px;
  background: var(--surface-alt);
  border-radius: 10px;
  display: none;
}

.progress-container.active { display: block; }

.progress-bar {
  width: 100%;
  height: 8px;
  background: var(--border);
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 10px;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary), var(--accent));
  width: 0%;
  transition: width 0.3s ease;
  border-radius: 10px;
}

.progress-text {
  text-align: center;
  font-size: 0.9rem;
  color: var(--text-muted);
  font-family: 'IBM Plex Mono', monospace;
}

.results-container { display: none; animation: slideUp 0.5s ease; }
.results-container.active { display: block; }

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.stat-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: linear-gradient(135deg, var(--surface-alt), var(--surface));
  padding: 24px;
  border-radius: 12px;
  border-left: 4px solid var(--primary);
  transition: all 0.3s ease;
}

.stat-card:hover { transform: translateX(4px); box-shadow: var(--shadow); }
.stat-card.positive { border-left-color: var(--success); }
.stat-card.negative { border-left-color: var(--danger); }
.stat-card.warning { border-left-color: var(--warning); }
.stat-card.info { border-left-color: var(--info); }

.stat-label {
  font-size: 0.875rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 8px;
  font-weight: 600;
  font-family: 'IBM Plex Mono', monospace;
}

.stat-value {
  font-size: 2rem;
  font-weight: 800;
  color: var(--primary);
  font-family: 'IBM Plex Mono', monospace;
}

.stat-change { font-size: 0.875rem; margin-top: 8px; font-weight: 600; }
.stat-change.positive { color: var(--success); }
.stat-change.negative { color: var(--danger); }

.chart-container {
  position: relative;
  height: 400px;
  margin-top: 30px;
  padding: 20px;
  background: var(--surface);
  border-radius: 12px;
  box-shadow: var(--shadow);
}

.insights-container {
  background: linear-gradient(135deg, var(--primary-dark), var(--primary));
  color: white;
  padding: 30px;
  border-radius: 16px;
  margin-top: 30px;
  box-shadow: var(--shadow-lg);
}

.insights-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px solid rgba(255, 255, 255, 0.2);
}

.insights-title { font-size: 1.5rem; font-weight: 700; }

.insight-item {
  background: rgba(255, 255, 255, 0.1);
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 12px;
  border-left: 4px solid var(--accent);
  backdrop-filter: blur(10px);
}

.insight-text { line-height: 1.7; font-size: 1.05rem; }

.breakdown-table {
  width: 100%;
  margin-top: 20px;
  border-collapse: collapse;
  font-family: 'IBM Plex Mono', monospace;
}

.breakdown-table th {
  text-align: left;
  padding: 12px;
  background: var(--primary-dark);
  color: white;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.875rem;
  letter-spacing: 0.05em;
}

.breakdown-table td { padding: 12px; border-bottom: 1px solid var(--border); }
.breakdown-table tr:hover { background: var(--surface-alt); }
.breakdown-table .amount { text-align: right; font-weight: 600; font-size: 1.05rem; }
.breakdown-table .percentage { text-align: center; font-size: 0.9rem; color: var(--text-muted); }

.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border-bottom: 2px solid var(--border);
  flex-wrap: wrap;
}

.tab {
  padding: 12px 24px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-muted);
  transition: all 0.2s ease;
  font-family: 'Darker Grotesque', sans-serif;
}

.tab:hover { color: var(--primary); }
.tab.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeIn 0.3s ease; }

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.simulation-controls {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
  padding: 20px;
  background: var(--surface-alt);
  border-radius: 12px;
}

.slider-group { margin-bottom: 10px; }

.slider-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text);
}

.slider-value { color: var(--primary); font-family: 'IBM Plex Mono', monospace; }

input[type="range"] {
  width: 100%;
  height: 6px;
  border-radius: 5px;
  background: var(--border);
  outline: none;
  -webkit-appearance: none;
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--primary);
  cursor: pointer;
  transition: all 0.2s ease;
}

input[type="range"]::-webkit-slider-thumb:hover {
  background: var(--primary-light);
  transform: scale(1.2);
}

input[type="range"]::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--primary);
  cursor: pointer;
  border: none;
}

.comparison-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-top: 20px;
}

.comparison-card { padding: 20px; background: var(--surface-alt); border-radius: 12px; text-align: center; }

.comparison-label {
  font-size: 0.875rem;
  color: var(--text-muted);
  margin-bottom: 8px;
  text-transform: uppercase;
  font-weight: 600;
}

.comparison-value {
  font-size: 1.75rem;
  font-weight: 800;
  color: var(--primary);
  font-family: 'IBM Plex Mono', monospace;
}

.alert {
  padding: 16px 20px;
  border-radius: 10px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 500;
}

.alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid var(--success); }
.alert-warning { background: #fef3c7; color: #92400e; border-left: 4px solid var(--warning); }
.alert-error { background: #fee2e2; color: #991b1b; border-left: 4px solid var(--danger); }
.alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid var(--info); }

.summary-box {
  background: linear-gradient(135deg, var(--accent), var(--accent-hover));
  color: var(--primary-dark);
  padding: 30px;
  border-radius: 16px;
  margin-bottom: 30px;
  box-shadow: var(--shadow-lg);
}

.summary-title {
  font-size: 1.5rem;
  font-weight: 800;
  margin-bottom: 20px;
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 20px;
}

.summary-item {
  text-align: center;
  padding: 15px;
  background: rgba(255, 255, 255, 0.3);
  border-radius: 10px;
  backdrop-filter: blur(10px);
}

.summary-item-label {
  font-size: 0.85rem;
  font-weight: 600;
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.summary-item-value {
  font-size: 1.8rem;
  font-weight: 800;
  font-family: 'IBM Plex Mono', monospace;
}

@media (max-width: 768px) {
  .header h1 { font-size: 2rem; }
  .card { padding: 20px; }
  .stat-grid { grid-template-columns: 1fr; }
  .tabs { overflow-x: auto; }
  .chart-container { height: 300px; }
  .simulation-controls { grid-template-columns: 1fr; }
}

@media print {
  body { background: white; }
  .btn, .upload-area, .tabs { display: none; }
  .card { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; }
  .historico-container { display: none; }
}
</style>
</head>

<body>
<div class="container">
  <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
  <div class="header">
    <h1>üí∞ ContraCheque AI</h1>
    <p class="subtitle">An√°lise Inteligente com Sincroniza√ß√£o Google Sheets</p>
    <div class="status-sync" id="syncStatus">‚è≥ Aguardando dados...</div>
  </div>

  <div class="historico-container" id="historicoContainer">
    <div class="card-header">
      <span class="card-icon">üìä</span>
      <h2 class="card-title">Hist√≥rico de Contracheques</h2>
    </div>

    <div class="filtros-container">
      <div class="form-group" style="margin: 0;">
        <label class="form-label" for="filtroMes">Filtrar por M√™s/Ano</label>
        <input type="month" id="filtroMes" onchange="filtrarHistorico()">
      </div>

      <div class="form-group" style="margin: 0;">
        <label class="form-label" for="filtroExibicao">Exibi√ß√£o</label>
        <select id="filtroExibicao" onchange="filtrarHistorico()">
          <option value="todos">Todos os Registros</option>
          <option value="recente" selected>Mais Recente</option>
          <option value="nenhum">Ocultar Todos</option>
          <option value="ultimos3">√öltimos 3 Meses</option>
          <option value="ultimos6">√öltimos 6 Meses</option>
          <option value="ano">Ano Atual</option>
        </select>
      </div>

      <div style="display: flex; align-items: flex-end; gap: 10px;">
        <button class="btn btn-info" onclick="exibirGraficoEvolucao()" style="padding: 12px 20px; font-size: 0.95rem;">
          <span>üìà</span>
          <span>Evolu√ß√£o</span>
        </button>
        <button class="btn btn-accent" onclick="limparHistorico()" style="padding: 12px 20px; font-size: 0.95rem;">
          <span>üóëÔ∏è</span>
          <span>Limpar</span>
        </button>
      </div>
    </div>

    <div id="historicoTableContainer"></div>
    <div id="graficoEvolucaoContainer" style="display: none; margin-top: 30px;">
      <h3 style="margin-bottom: 20px; color: var(--primary);">üìà Evolu√ß√£o dos Contracheques</h3>
      <div class="chart-container">
        <canvas id="graficoEvolucao"></canvas>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-header">
        <span class="card-icon">üì•</span>
        <h2 class="card-title">Importar Documento</h2>
      </div>

      <div class="form-group">
        <label class="form-label" for="mesAnoReferencia">üìÖ M√™s/Ano de Refer√™ncia *</label>
        <input type="month" id="mesAnoReferencia" required style="padding: 14px; border: 2px solid var(--primary);">
      </div>
      
      <div class="upload-area" id="uploadArea">
        <div class="upload-icon">üìÑ</div>
        <div class="upload-text">Arraste o PDF/imagem aqui ou clique para selecionar</div>
        <div class="upload-hint">Suporta PDF e imagens (JPG, PNG)</div>
        <input type="file" id="arquivo" accept=".pdf,image/*">
      </div>

      <div style="margin: 20px 0; text-align: center; color: var(--text-muted); font-weight: 600;">OU</div>

      <div class="form-group">
        <label class="form-label" for="textoColado">Cole o Texto do Contracheque</label>
        <textarea id="textoColado" placeholder="Cole aqui o texto completo do seu contracheque..."></textarea>
      </div>

      <button class="btn btn-primary btn-full" onclick="processar()">
        <span>üîç</span>
        <span>Processar e Analisar</span>
      </button>

      <div class="progress-container" id="progressContainer">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">Processando...</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-icon">‚úèÔ∏è</span>
        <h2 class="card-title">Entrada Manual</h2>
      </div>

      <div class="form-group">
        <label class="form-label" for="mesAnoManual">üìÖ M√™s/Ano de Refer√™ncia *</label>
        <input type="month" id="mesAnoManual" required style="padding: 14px; border: 2px solid var(--primary);">
      </div>

      <div class="form-group">
        <label class="form-label" for="totalBrutoManual">Total Bruto</label>
        <div class="input-wrapper">
          <span class="input-prefix">R$</span>
          <input type="number" id="totalBrutoManual" placeholder="0,00" step="0.01" min="0">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="totalDescontosManual">Total Descontos</label>
        <div class="input-wrapper">
          <span class="input-prefix">R$</span>
          <input type="number" id="totalDescontosManual" placeholder="0,00" step="0.01" min="0">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label" for="totalLiquidoManual">Total L√≠quido</label>
        <div class="input-wrapper">
          <span class="input-prefix">R$</span>
          <input type="number" id="totalLiquidoManual" placeholder="0,00" step="0.01" min="0">
        </div>
      </div>

      <button class="btn btn-accent btn-full" onclick="analisarManual()">
        <span>üìä</span>
        <span>Analisar Valores Manuais</span>
      </button>

      <div style="margin-top: 20px; padding: 15px; background: var(--info); color: white; border-radius: 10px; font-size: 0.9rem;">
        <strong>üí° Dica:</strong> Os dados ser√£o sincronizados automaticamente com o Google Sheets!
      </div>
    </div>
  </div>

  <div class="results-container" id="resultsContainer">
    <div class="summary-box" id="summaryBox">
      <div class="summary-title">üìä Resumo Executivo</div>
      <div class="summary-grid" id="summaryGrid"></div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-icon">üìà</span>
        <h2 class="card-title">An√°lise Detalhada</h2>
      </div>
      <div class="stat-grid" id="statsGrid"></div>
      <div class="chart-container">
        <canvas id="grafico"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top: 30px;">
      <div class="tabs">
        <button class="tab active" onclick="switchResultTab('detalhes')">üìã Detalhes</button>
        <button class="tab" onclick="switchResultTab('comparativo')">üéØ Comparativo</button>
        <button class="tab" onclick="switchResultTab('simulacao')">üîÆ Simula√ß√£o</button>
        <button class="tab" onclick="switchResultTab('graficos')">üìä Gr√°ficos</button>
      </div>
      <div id="detalhes-result-tab" class="tab-content active"><div id="detailsContent"></div></div>
      <div id="comparativo-result-tab" class="tab-content"><div id="comparisonContent"></div></div>
      <div id="simulacao-result-tab" class="tab-content">
        <h3 style="margin-bottom: 20px; color: var(--primary);">üîÆ Simulador de Cen√°rios</h3>
        <div class="simulation-controls" id="simulationControls"></div>
        <div id="simulationResults"></div>
      </div>
    </div>

    <div class="insights-container" id="insightsContainer">
      <div class="insights-header">
        <span style="font-size: 2rem;">ü§ñ</span>
        <h3 class="insights-title">Insights Inteligentes</h3>
      </div>
      <div id="insightsContent"></div>
    </div>

    <div style="margin-top: 30px; text-align: center;">
      <button class="btn btn-primary" onclick="exportarRelatorio()"><span>üìÑ</span><span>Exportar PDF</span></button>
      <button class="btn btn-accent" onclick="window.print()" style="margin-left: 10px;"><span>üñ®Ô∏è</span><span>Imprimir</span></button>
      <button class="btn btn-info" onclick="resetar()" style="margin-left: 10px;"><span>üîÑ</span><span>Nova An√°lise</span></button>
    </div>
  </div>
</div>
<div id="graficos-result-tab" class="tab-content">
  <h3 style="margin-bottom: 20px; color: var(--primary);">üìä An√°lises Visuais</h3>
  
  <div class="chart-container" style="margin-bottom: 30px;">
    <h4 style="margin-bottom: 15px;">Descontos por Categoria</h4>
    <canvas id="graficoCategoriasDescontos"></canvas>
  </div>
  
  <div class="chart-container" style="margin-bottom: 30px;">
    <h4 style="margin-bottom: 15px;">Composi√ß√£o do Bruto</h4>
    <canvas id="graficoComposicaoBruto"></canvas>
  </div>
  
  <div class="chart-container">
    <h4 style="margin-bottom: 15px;">Comparativo: Entrada vs Sa√≠da</h4>
    <canvas id="graficoEntradaSaida"></canvas>
  </div>
</div>
<script>
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby3VFHiTu4oztFIM18Tve-RGFOMDef7bOoddFJRVMTYN8YhElpaZEVJusf-t2_Vba91yg/exec';

let chartInstance = null;
let chartEvolucaoInstance = null;
let dados = { mesAno: '', bruto: 0, liquido: 0, totalDescontos: 0, ganhos: [], descontos: [], emprestimos: [], itensExtrados: false };
let chartCategoriasInstance = null;
let chartComposicaoInstance = null;
let chartEntradaSaidaInstance = null;

function renderGraficosAdicionais() {
  renderGraficoCategoriasDescontos();
  renderGraficoComposicaoBruto();
  renderGraficoEntradaSaida();
}

function renderGraficoCategoriasDescontos() {
  const totalObrig = (dados.descontosObrigatorios || []).reduce((sum, i) => sum + i.valor, 0);
  const totalEmp = (dados.emprestimos || []).reduce((sum, i) => sum + i.valor, 0);
  const totalBenef = (dados.beneficios || []).reduce((sum, i) => sum + i.valor, 0);
  const totalOutros = dados.totalDescontos - totalObrig - totalEmp - totalBenef;
  
  const ctx = document.getElementById('graficoCategoriasDescontos').getContext('2d');
  if (chartCategoriasInstance) chartCategoriasInstance.destroy();
  
  chartCategoriasInstance = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Obrigat√≥rios', 'Empr√©stimos', 'Benef√≠cios', 'Outros'],
      datasets: [{
        data: [totalObrig, totalEmp, totalBenef, totalOutros],
        backgroundColor: [
          'rgba(239, 68, 68, 0.8)',
          'rgba(245, 158, 11, 0.8)',
          'rgba(59, 130, 246, 0.8)',
          'rgba(107, 114, 128, 0.8)'
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right' },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.parsed;
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((value / total) * 100).toFixed(1);
              return `${context.label}: R$ ${formatMoney(value)} (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}

function renderGraficoComposicaoBruto() {
  const ganhosPorItem = (dados.ganhos || []).map(g => ({ label: g.descricao, valor: g.valor }));
  
  const ctx = document.getElementById('graficoComposicaoBruto').getContext('2d');
  if (chartComposicaoInstance) chartComposicaoInstance.destroy();
  
  chartComposicaoInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ganhosPorItem.map(g => g.label),
      datasets: [{
        label: 'Valores',
        data: ganhosPorItem.map(g => g.valor),
        backgroundColor: 'rgba(16, 185, 129, 0.8)',
        borderColor: 'rgba(16, 185, 129, 1)',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'R$ ' + formatMoney(context.parsed.x);
            }
          }
        }
      },
      scales: {
        x: {
          ticks: {
            callback: function(value) {
              return 'R$ ' + formatMoney(value);
            }
          }
        }
      }
    }
  });
}

function renderGraficoEntradaSaida() {
  const ctx = document.getElementById('graficoEntradaSaida').getContext('2d');
  if (chartEntradaSaidaInstance) chartEntradaSaidaInstance.destroy();
  
  chartEntradaSaidaInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['Financeiro'],
      datasets: [
        {
          label: 'Bruto',
          data: [dados.bruto],
          backgroundColor: 'rgba(16, 185, 129, 0.8)',
          borderColor: 'rgba(16, 185, 129, 1)',
          borderWidth: 2
        },
        {
          label: 'Descontos',
          data: [dados.totalDescontos],
          backgroundColor: 'rgba(239, 68, 68, 0.8)',
          borderColor: 'rgba(239, 68, 68, 1)',
          borderWidth: 2
        },
        {
          label: 'L√≠quido',
          data: [dados.liquido],
          backgroundColor: 'rgba(232, 185, 49, 0.8)',
          borderColor: 'rgba(232, 185, 49, 1)',
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': R$ ' + formatMoney(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'R$ ' + formatMoney(value);
            }
          }
        }
      }
    }
  });
}

// ============================================
// FUN√á√ïES DE SINCRONIZA√á√ÉO
// ============================================

function updateSyncStatus(status, message) {
  const syncEl = document.getElementById('syncStatus');
  syncEl.className = 'status-sync ' + status;
  syncEl.innerHTML = message;
}

async function sincronizarComSheets() {
  try {
    updateSyncStatus('', '‚è≥ Sincronizando...');
    
    const dadosParaEnviar = {
      mes: dados.mesAno,
      bruto: dados.bruto,
      descontos: dados.totalDescontos,
      liquido: dados.liquido,
      emprestimos: dados.emprestimos || []
    };

    const response = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify(dadosParaEnviar)
    });

    if (response.ok) {
      updateSyncStatus('synced', '‚úÖ Sincronizado com Google Sheets');
      setTimeout(() => updateSyncStatus('synced', '‚òÅÔ∏è Dados salvos na nuvem'), 3000);
    } else {
      throw new Error('Erro na resposta');
    }
  } catch (error) {
    console.error('Erro ao sincronizar:', error);
    updateSyncStatus('error', '‚ö†Ô∏è Erro na sincroniza√ß√£o - Dados salvos localmente');
  }
}

// ============================================
// FUN√á√ïES DE HIST√ìRICO LOCAL
// ============================================

function salvarNoHistorico() {
  try {
    let historico = JSON.parse(localStorage.getItem('historicoContracheques') || '[]');
    const registro = {
      id: Date.now(),
      mesAno: dados.mesAno,
      bruto: dados.bruto,
      descontos: dados.totalDescontos,
      liquido: dados.liquido,
      percentualDescontos: dados.percentualDescontos,
      ganhos: dados.ganhos,
      descontos_itens: dados.descontos,
      emprestimos: dados.emprestimos,
      dataAnalise: new Date().toISOString()
    };
    
    const indexExistente = historico.findIndex(h => h.mesAno === dados.mesAno);
    
    if (indexExistente >= 0) {
      if (confirm(`J√° existe um registro para ${formatMesAno(dados.mesAno)}. Deseja substituir?`)) {
        historico[indexExistente] = registro;
        showAlert(`‚úÖ Registro de ${formatMesAno(dados.mesAno)} atualizado!`, 'success');
      } else return;
    } else {
      historico.push(registro);
      showAlert(`‚úÖ Registro de ${formatMesAno(dados.mesAno)} salvo!`, 'success');
    }
    
    localStorage.setItem('historicoContracheques', JSON.stringify(historico));
    carregarHistorico();
  } catch (error) {
    console.error('Erro ao salvar:', error);
    showAlert('‚ùå Erro ao salvar no hist√≥rico.', 'error');
  }
}

function carregarHistorico() {
  try {
    const historico = JSON.parse(localStorage.getItem('historicoContracheques') || '[]');
    
    if (historico.length === 0) {
      document.getElementById('historicoTableContainer').innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
          <div style="font-size: 3rem; margin-bottom: 15px;">üì≠</div>
          <div style="font-size: 1.2rem; font-weight: 600;">Nenhum contracheque analisado ainda</div>
          <div style="margin-top: 10px;">Comece adicionando seu primeiro contracheque acima!</div>
        </div>`;
      return;
    }
    
    historico.sort((a, b) => new Date(b.dataAnalise) - new Date(a.dataAnalise));
    let historicoFiltrado = aplicarFiltros(historico);
    
    if (historicoFiltrado.length === 0) {
      document.getElementById('historicoTableContainer').innerHTML = `
        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
          <div style="font-size: 3rem; margin-bottom: 15px;">üîç</div>
          <div style="font-size: 1.2rem; font-weight: 600;">Nenhum registro encontrado</div>
          <div style="margin-top: 10px;">Altere os filtros para ver mais resultados.</div>
        </div>`;
      return;
    }
    
    let html = `<table class="historico-table"><thead><tr>
      <th>üìÖ M√™s/Ano</th>
      <th class="amount">üíµ Bruto</th>
      <th class="amount">üìâ Descontos</th>
      <th class="amount">üí∞ L√≠quido</th>
      <th style="text-align: center;">üìä Taxa</th>
      <th style="text-align: center;">üè∑Ô∏è Status</th>
      <th style="text-align: center;">‚öôÔ∏è A√ß√µes</th>
    </tr></thead><tbody>`;
    
    historicoFiltrado.forEach(registro => {
      const badge = registro.percentualDescontos > 35 ? 'badge-danger' : 
                    registro.percentualDescontos > 25 ? 'badge-warning' : 'badge-success';
      const status = registro.percentualDescontos > 35 ? 'Alto' : 
                     registro.percentualDescontos > 25 ? 'M√©dio' : 'Baixo';
      
      html += `<tr onclick="visualizarRegistro(${registro.id})">
        <td><strong>${formatMesAno(registro.mesAno)}</strong></td>
        <td class="amount">R$ ${formatMoney(registro.bruto)}</td>
        <td class="amount" style="color: var(--danger);">R$ ${formatMoney(registro.descontos)}</td>
        <td class="amount" style="color: var(--success);">R$ ${formatMoney(registro.liquido)}</td>
        <td style="text-align: center; font-family: 'IBM Plex Mono', monospace; font-weight: 700;">
          ${registro.percentualDescontos.toFixed(1)}%
        </td>
        <td style="text-align: center;"><span class="badge ${badge}">${status}</span></td>
        <td style="text-align: center;">
          <button onclick="event.stopPropagation(); excluirRegistro(${registro.id})" 
            style="background: var(--danger); color: white; border: none; padding: 6px 12px; 
            border-radius: 6px; cursor: pointer; font-size: 0.85rem;">üóëÔ∏è</button>
        </td>
      </tr>`;
    });
    
    html += `</tbody></table>
      <div style="margin-top: 15px; padding: 12px; background: var(--surface-alt); 
        border-radius: 8px; text-align: center; font-size: 0.9rem; color: var(--text-muted);">
        üìä Exibindo <strong>${historicoFiltrado.length}</strong> de <strong>${historico.length}</strong> registros
      </div>`;
    
    document.getElementById('historicoTableContainer').innerHTML = html;
  } catch (error) {
    console.error('Erro ao carregar:', error);
  }
}

function aplicarFiltros(historico) {
  const filtroMes = document.getElementById('filtroMes').value;
  const filtroExibicao = document.getElementById('filtroExibicao').value;
  let historicoFiltrado = [...historico];
  
  if (filtroMes) {
    historicoFiltrado = historicoFiltrado.filter(h => h.mesAno === filtroMes);
  }
  
  switch (filtroExibicao) {
    case 'nenhum': 
      historicoFiltrado = []; 
      break;
    case 'recente': 
      historicoFiltrado = historicoFiltrado.slice(0, 1); 
      break;
    case 'ultimos3': 
      historicoFiltrado = historicoFiltrado.slice(0, 3); 
      break;
    case 'ultimos6': 
      historicoFiltrado = historicoFiltrado.slice(0, 6); 
      break;
    case 'ano': 
      const anoAtual = new Date().getFullYear(); 
      historicoFiltrado = historicoFiltrado.filter(h => h.mesAno.startsWith(anoAtual.toString())); 
      break;
  }
  
  return historicoFiltrado;
}

function filtrarHistorico() { 
  carregarHistorico(); 
}

function visualizarRegistro(id) {
  try {
    const historico = JSON.parse(localStorage.getItem('historicoContracheques') || '[]');
    const registro = historico.find(h => h.id === id);
    
    if (!registro) { 
      showAlert('‚ùå Registro n√£o encontrado.', 'error'); 
      return; 
    }
    
    dados.mesAno = registro.mesAno;
    dados.bruto = registro.bruto;
    dados.totalDescontos = registro.descontos;
    dados.liquido = registro.liquido;
    dados.percentualDescontos = registro.percentualDescontos;
    dados.ganhos = registro.ganhos || [];
    dados.descontos = registro.descontos_itens || [];
    dados.emprestimos = registro.emprestimos || [];
    dados.percentualLiquido = 100 - registro.percentualDescontos;
    
    document.getElementById('resultsContainer').classList.add('active');
    renderSummary(registro.bruto, registro.descontos, registro.liquido);
    renderStats(registro.bruto, registro.descontos, registro.liquido, registro.percentualDescontos);
    renderChart(registro.bruto, registro.descontos, registro.liquido);
    renderDetails();
    renderComparison(registro.bruto, registro.descontos, registro.liquido, registro.percentualDescontos);
    renderSimulation();
    generateInsights(registro.percentualDescontos, dados.percentualLiquido);
    
    document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
    showAlert(`üìä Visualizando contracheque de ${formatMesAno(registro.mesAno)}`, 'info');
  } catch (error) {
    console.error('Erro:', error);
    showAlert('‚ùå Erro ao carregar registro.', 'error');
  }
}

function excluirRegistro(id) {
  if (confirm('‚ö†Ô∏è Tem certeza que deseja excluir este registro?')) {
    try {
      let historico = JSON.parse(localStorage.getItem('historicoContracheques') || '[]');
      historico = historico.filter(h => h.id !== id);
      localStorage.setItem('historicoContracheques', JSON.stringify(historico));
      carregarHistorico();
      showAlert('‚úÖ Registro exclu√≠do com sucesso!', 'success');
    } catch (error) {
      console.error('Erro:', error);
      showAlert('‚ùå Erro ao excluir.', 'error');
    }
  }
}

function limparHistorico() {
  if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° excluir TODOS os registros. Deseja continuar?')) {
    if (confirm('üö® √öltima confirma√ß√£o: Todos os dados ser√£o perdidos!')) {
      localStorage.removeItem('historicoContracheques');
      carregarHistorico();
      showAlert('‚úÖ Hist√≥rico limpo!', 'success');
    }
  }
}

function formatMesAno(mesAno) {
  if (!mesAno) return 'N/A';
  const [ano, mes] = mesAno.split('-');
  const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
  return `${meses[parseInt(mes) - 1]}/${ano}`;
}

function exibirGraficoEvolucao() {
  const container = document.getElementById('graficoEvolucaoContainer');
  
  if (container.style.display === 'block') { 
    container.style.display = 'none'; 
    return; 
  }
  
  try {
    const historico = JSON.parse(localStorage.getItem('historicoContracheques') || '[]');
    
    if (historico.length === 0) { 
      showAlert('üì≠ Nenhum dado para exibir.', 'warning'); 
      return; 
    }
    
    historico.sort((a, b) => a.mesAno.localeCompare(b.mesAno));
    
    const labels = historico.map(h => formatMesAno(h.mesAno));
    const brutos = historico.map(h => h.bruto);
    const descontos = historico.map(h => h.descontos);
    const liquidos = historico.map(h => h.liquido);
    
    const ctx = document.getElementById('graficoEvolucao').getContext('2d');
    
    if (chartEvolucaoInstance) chartEvolucaoInstance.destroy();
    
    chartEvolucaoInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [
          { 
            label: 'Bruto', 
            data: brutos, 
            borderColor: 'rgb(10, 77, 60)', 
            backgroundColor: 'rgba(10, 77, 60, 0.1)', 
            tension: 0.4 
          },
          { 
            label: 'Descontos', 
            data: descontos, 
            borderColor: 'rgb(239, 68, 68)', 
            backgroundColor: 'rgba(239, 68, 68, 0.1)', 
            tension: 0.4 
          },
          { 
            label: 'L√≠quido', 
            data: liquidos, 
            borderColor: 'rgb(232, 185, 49)', 
            backgroundColor: 'rgba(232, 185, 49, 0.1)', 
            tension: 0.4 
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: { 
            callbacks: { 
              label: function(context) { 
                return context.dataset.label + ': R$ ' + formatMoney(context.parsed.y); 
              } 
            } 
          }
        },
        scales: { 
          y: { 
            beginAtZero: true, 
            ticks: { 
              callback: function(value) { 
                return 'R$ ' + formatMoney(value); 
              } 
            } 
          } 
        }
      }
    });
    
    container.style.display = 'block';
    container.scrollIntoView({ behavior: 'smooth', block: 'center' });
  } catch (error) {
    console.error('Erro:', error);
    showAlert('‚ùå Erro ao gerar gr√°fico.', 'error');
  }
}

// ============================================
// FUN√á√ïES DE UPLOAD E DRAG & DROP
// ============================================

const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('arquivo');

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => 
  uploadArea.addEventListener(e, preventDefaults, false)
);

function preventDefaults(e) { 
  e.preventDefault(); 
  e.stopPropagation(); 
}

['dragenter', 'dragover'].forEach(e => 
  uploadArea.addEventListener(e, () => uploadArea.classList.add('dragover'))
);

['dragleave', 'drop'].forEach(e => 
  uploadArea.addEventListener(e, () => uploadArea.classList.remove('dragover'))
);

uploadArea.addEventListener('drop', (e) => { 
  fileInput.files = e.dataTransfer.files; 
  processar(); 
});

// ============================================
// FUN√á√ïES DE PROCESSAMENTO
// ============================================

function switchResultTab(tab) {
  event.target.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  event.target.parentElement.parentElement.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(`${tab}-result-tab`).classList.add('active');
}

function updateProgress(percent, text) {
  const progressContainer = document.getElementById('progressContainer');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  
  progressContainer.classList.add('active');
  progressFill.style.width = percent + '%';
  progressText.textContent = text;
  
  if (percent >= 100) {
    setTimeout(() => progressContainer.classList.remove('active'), 1000);
  }
}

async function processar() {
  const file = document.getElementById("arquivo").files[0];
  let texto = document.getElementById("textoColado").value;
  const mesAno = document.getElementById("mesAnoReferencia").value;
  
  if (!mesAno) { 
    showAlert('‚ö†Ô∏è Selecione o M√™s/Ano!', 'warning'); 
    document.getElementById('mesAnoReferencia').focus(); 
    return; 
  }
  
  if (!file && !texto) { 
    showAlert('Envie um arquivo ou cole o texto.', 'warning'); 
    return; 
  }
  
  dados.mesAno = mesAno;
  updateProgress(10, 'Iniciando...');
  
  if (file) {
    if (file.type === "application/pdf") {
      updateProgress(30, 'Lendo PDF...');
      const reader = new FileReader();
      reader.onload = async function () {
        try {
          const pdf = await pdfjsLib.getDocument({data: reader.result}).promise;
          updateProgress(50, 'Extraindo...');
          let content = "";
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const text = await page.getTextContent();
            content += text.items.map(t => t.str).join(" ") + "\n";
          }
          updateProgress(80, 'Analisando...');
          extrairDados(content);
          updateProgress(100, 'Conclu√≠do!');
        } catch (error) {
          updateProgress(0, '');
          showAlert('Erro: ' + error.message, 'error');
        }
      };
      reader.readAsArrayBuffer(file);
    } else {
      updateProgress(30, 'Processando imagem...');
      try {
        const { data } = await Tesseract.recognize(file, 'por', {
          logger: m => { 
            if (m.status === 'recognizing text') {
              updateProgress(30 + (m.progress * 50), 'Reconhecendo...'); 
            }
          }
        });
        updateProgress(90, 'Finalizando...');
        extrairDados(data.text);
        updateProgress(100, 'Conclu√≠do!');
      } catch (error) {
        updateProgress(0, '');
        showAlert('Erro: ' + error.message, 'error');
      }
    }
  } else if (texto) {
    updateProgress(50, 'Processando...');
    extrairDados(texto);
    updateProgress(100, 'Conclu√≠do!');
  }
}

function extrairDados(txt) {
  let totalBruto = 0, totalDescontos = 0, totalLiquido = 0;
  
  const linhasTotais = [
    /TOTAL\s+DE\s+GANHOS[^0-9]*?(\d{1,3}(?:\.\d{3})*,\d{2})[^0-9]*?TOTAL\s+DE\s+DESCONTOS[^0-9]*?(\d{1,3}(?:\.\d{3})*,\d{2})[^0-9]*?L[I√ç]QUIDO[^0-9]*?(\d{1,3}(?:\.\d{3})*,\d{2})/i,
    /\*+\s*(\d{1,3}(?:\.\d{3})*,\d{2})\s+\*+\s*(\d{1,3}(?:\.\d{3})*,\d{2})\s+\*+\s*(\d{1,3}(?:\.\d{3})*,\d{2})/i,
    /TOTAL.*?(\d{1,3}(?:\.\d{3})*,\d{2}).*?(\d{1,3}(?:\.\d{3})*,\d{2}).*?(\d{1,3}(?:\.\d{3})*,\d{2})/i
  ];
  
  for (let regex of linhasTotais) {
    const match = txt.match(regex);
    if (match) {
      totalBruto = parseValorBR(match[1]);
      totalDescontos = parseValorBR(match[2]);
      totalLiquido = parseValorBR(match[3]);
      break;
    }
  }
  
  if (totalBruto === 0) {
    extrairItensIndividuais(txt);
  } else {
    dados.bruto = totalBruto;
    dados.totalDescontos = totalDescontos;
    dados.liquido = totalLiquido;
    dados.itensExtrados = true;
    extrairItensIndividuais(txt);
    analisar();
    showAlert(`‚úÖ Processado! Bruto R$ ${formatMoney(totalBruto)} | Descontos R$ ${formatMoney(totalDescontos)} | L√≠quido R$ ${formatMoney(totalLiquido)}`, 'success');
  }
}

function parseValorBR(valor) {
  if (!valor) return 0;
  return parseFloat(valor.toString().replace(/\./g, '').replace(',', '.')) || 0;
}

function extrairItensIndividuais(txt) {
  dados.ganhos = []; 
  dados.descontos = []; 
  dados.emprestimos = [];
  
  const linhas = txt.split('\n');
  
  for (let linha of linhas) {
    const matchValor = linha.match(/(\d{1,3}(?:\.\d{3})*,\d{2})/g);
    
    if (matchValor && matchValor.length > 0) {
      const valor = parseValorBR(matchValor[matchValor.length - 1]);
      const descricao = linha.replace(/^\d+\s*/, '').replace(/\d.*$/, '').trim();
      
      if (valor > 0 && descricao.length > 3) {
        const matchParcelas = linha.match(/(\d{3})\|(\d{3})/);
        const ehEmprestimo = /BANCO|EMP|CART|CONSIG|EMPREST/i.test(linha);
        const ehDesconto = /IMPOSTO|PREV|INSS|DESCONTO/i.test(linha);
        
        if (ehEmprestimo && matchParcelas) {
          dados.emprestimos.push({ 
            descricao, 
            valor, 
            parcelaAtual: parseInt(matchParcelas[1]), 
            totalParcelas: parseInt(matchParcelas[2]) 
          });
          dados.descontos.push({ descricao, valor });
        } else if (ehDesconto || ehEmprestimo) {
          dados.descontos.push({ descricao, valor });
        } else if (/SOLDO|SALARIO|GRAT|EXTRA|BONUS|ETAPA|VENCIMENTO/i.test(linha)) {
          dados.ganhos.push({ descricao, valor });
        }
      }
    }
  }
}

function analisarManual() {
  const mesAno = document.getElementById("mesAnoManual").value;
  const bruto = parseFloat(document.getElementById("totalBrutoManual").value) || 0;
  const descontos = parseFloat(document.getElementById("totalDescontosManual").value) || 0;
  const liquido = parseFloat(document.getElementById("totalLiquidoManual").value) || 0;
  
  if (!mesAno) { 
    showAlert('‚ö†Ô∏è Selecione o M√™s/Ano!', 'warning'); 
    document.getElementById('mesAnoManual').focus(); 
    return; 
  }
  
  if (bruto === 0) { 
    showAlert('Insira o Total Bruto.', 'warning'); 
    return; 
  }
  
  const liquidoCalculado = liquido > 0 ? liquido : (bruto - descontos);
  
  dados.mesAno = mesAno;
  dados.bruto = bruto;
  dados.totalDescontos = descontos;
  dados.liquido = liquidoCalculado;
  dados.itensExtrados = false;
  
  analisar();
  showAlert('‚úÖ An√°lise conclu√≠da!', 'success');
}

function analisar() {
  const bruto = dados.bruto, descontos = dados.totalDescontos, liquido = dados.liquido;
  if (bruto === 0) {
    showAlert('N√£o foi poss√≠vel extrair os valores.', 'error');
    return;
  }
  const liquidoCalculado = Math.round((bruto - descontos) * 100) / 100;
  const diferencaLiquido = Math.abs(liquido - liquidoCalculado);
  if (diferencaLiquido > 0.10) {
    showAlert(`‚ö†Ô∏è L√≠quido informado (R$ ${formatMoney(liquido)}) difere do calculado (R$ ${formatMoney(liquidoCalculado)}).`, 'warning');
  }

  const percDescontos = bruto > 0 ? Math.round((descontos / bruto * 100) * 100) / 100 : 0;
  const percLiquido = bruto > 0 ? Math.round((liquido / bruto * 100) * 100) / 100 : 0;
  dados.percentualDescontos = percDescontos;
  dados.percentualLiquido = percLiquido;

  // Renderiza toda a interface de resultados
  document.getElementById('resultsContainer').classList.add('active');
  renderSummary(bruto, descontos, liquido);
  renderStats(bruto, descontos, liquido, percDescontos);
  renderChart(bruto, descontos, liquido);
  renderDetails();
  renderComparison(bruto, descontos, liquido, percDescontos);
  renderSimulation();
  generateInsights(percDescontos, percLiquido);

  // Salva no hist√≥rico e sincroniza
  salvarNoHistorico();
  sincronizarComSheets();
  renderGraficosAdicionais();

  // Scroll suave at√© os resultados
  document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function formatMoney(value) {
  if (typeof value !== 'number') return '0,00';
  return value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function renderSummary(bruto, descontos, liquido) {
  const container = document.getElementById('summaryGrid');
  container.innerHTML = `
    <div class="summary-item">
      <div class="summary-item-label">Bruto</div>
      <div class="summary-item-value">R$ ${formatMoney(bruto)}</div>
    </div>
    <div class="summary-item">
      <div class="summary-item-label">Descontos</div>
      <div class="summary-item-value" style="color: var(--danger);">R$ ${formatMoney(descontos)}</div>
    </div>
    <div class="summary-item">
      <div class="summary-item-label">L√≠quido</div>
      <div class="summary-item-value" style="color: var(--success);">R$ ${formatMoney(liquido)}</div>
    </div>
    <div class="summary-item">
      <div class="summary-item-label">Taxa de Desconto</div>
      <div class="summary-item-value">${dados.percentualDescontos.toFixed(1)}%</div>
    </div>
  `;
}

function renderStats(bruto, descontos, liquido, percDescontos) {
  const container = document.getElementById('statsGrid');
  container.innerHTML = `
    <div class="stat-card ${percDescontos > 35 ? 'negative' : percDescontos > 25 ? 'warning' : 'positive'}">
      <div class="stat-label">Taxa de Desconto</div>
      <div class="stat-value">${percDescontos.toFixed(1)}%</div>
      <div class="stat-change ${percDescontos > 35 ? 'negative' : percDescontos > 25 ? 'warning' : 'positive'}">
        ${percDescontos > 35 ? 'Alta ‚Äì aten√ß√£o!' : percDescontos > 25 ? 'Moderada' : 'Baixa ‚Äì √≥timo!'}
      </div>
    </div>
    <div class="stat-card info">
      <div class="stat-label">L√≠quido/Bruto</div>
      <div class="stat-value">${dados.percentualLiquido.toFixed(1)}%</div>
    </div>
    <div class="stat-card positive">
      <div class="stat-label">Valor L√≠quido</div>
      <div class="stat-value">R$ ${formatMoney(liquido)}</div>
    </div>
  `;
}

function renderChart(bruto, descontos, liquido) {
  const ctx = document.getElementById('grafico').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Bruto', 'Descontos'],
      datasets: [{
        data: [liquido, descontos],
        backgroundColor: ['rgba(232, 185, 49, 0.8)', 'rgba(239, 68, 68, 0.8)'],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.label + ': R$ ' + formatMoney(context.parsed);
            }
          }
        }
      }
    }
  });
}

function renderDetails() {
  let html = '<h3 style="margin-bottom: 15px; color: var(--primary);">üìã Detalhamento dos Itens</h3>';
  
  // Ganhos
  if (dados.ganhos && dados.ganhos.length > 0) {
    html += '<h4 style="margin: 20px 0 10px; color: var(--success);">üí∞ Ganhos</h4>';
    html += '<table class="breakdown-table"><thead><tr><th>Descri√ß√£o</th><th class="amount">Valor</th></tr></thead><tbody>';
    dados.ganhos.forEach(item => {
      html += `<tr><td>${item.descricao}</td><td class="amount">R$ ${formatMoney(item.valor)}</td></tr>`;
    });
    const totalGanhos = dados.ganhos.reduce((sum, i) => sum + i.valor, 0);
    html += `<tr style="background: var(--surface-alt); font-weight: 700;"><td>TOTAL</td><td class="amount">R$ ${formatMoney(totalGanhos)}</td></tr>`;
    html += '</tbody></table>';
  }
  
  // Descontos Obrigat√≥rios
  if (dados.descontosObrigatorios && dados.descontosObrigatorios.length > 0) {
    html += '<h4 style="margin: 20px 0 10px; color: var(--danger);">‚öñÔ∏è Descontos Obrigat√≥rios</h4>';
    html += '<table class="breakdown-table"><thead><tr><th>Descri√ß√£o</th><th class="amount">Valor</th></tr></thead><tbody>';
    dados.descontosObrigatorios.forEach(item => {
      html += `<tr><td>${item.descricao}</td><td class="amount">R$ ${formatMoney(item.valor)}</td></tr>`;
    });
    const totalObrig = dados.descontosObrigatorios.reduce((sum, i) => sum + i.valor, 0);
    html += `<tr style="background: var(--surface-alt); font-weight: 700;"><td>SUBTOTAL</td><td class="amount">R$ ${formatMoney(totalObrig)}</td></tr>`;
    html += '</tbody></table>';
  }
  
  // Empr√©stimos
  if (dados.emprestimos && dados.emprestimos.length > 0) {
    html += '<h4 style="margin: 20px 0 10px; color: var(--warning);">üè¶ Empr√©stimos/Consignados</h4>';
    html += '<table class="breakdown-table"><thead><tr><th>Descri√ß√£o</th><th class="amount">Valor</th><th style="text-align:center;">Parcela</th></tr></thead><tbody>';
    dados.emprestimos.forEach(item => {
      html += `<tr><td>${item.descricao}</td><td class="amount">R$ ${formatMoney(item.valor)}</td><td style="text-align:center;">${item.parcelaAtual}/${item.totalParcelas}</td></tr>`;
    });
    const totalEmp = dados.emprestimos.reduce((sum, i) => sum + i.valor, 0);
    html += `<tr style="background: var(--surface-alt); font-weight: 700;"><td>SUBTOTAL</td><td class="amount" colspan="2">R$ ${formatMoney(totalEmp)}</td></tr>`;
    html += '</tbody></table>';
  }
  
  // Benef√≠cios
  if (dados.beneficios && dados.beneficios.length > 0) {
    html += '<h4 style="margin: 20px 0 10px; color: var(--info);">üè• Benef√≠cios</h4>';
    html += '<table class="breakdown-table"><thead><tr><th>Descri√ß√£o</th><th class="amount">Valor</th></tr></thead><tbody>';
    dados.beneficios.forEach(item => {
      html += `<tr><td>${item.descricao}</td><td class="amount">R$ ${formatMoney(item.valor)}</td></tr>`;
    });
    const totalBenef = dados.beneficios.reduce((sum, i) => sum + i.valor, 0);
    html += `<tr style="background: var(--surface-alt); font-weight: 700;"><td>SUBTOTAL</td><td class="amount">R$ ${formatMoney(totalBenef)}</td></tr>`;
    html += '</tbody></table>';
  }
  
  document.getElementById('detailsContent').innerHTML = html || '<p>Nenhum item detalhado encontrado.</p>';
}

function renderComparison(bruto, descontos, liquido, percDescontos) {
  const historico = JSON.parse(localStorage.getItem('historicoContracheques') || '[]');
  const anteriores = historico.filter(h => h.mesAno !== dados.mesAno);
  if (anteriores.length === 0) {
    document.getElementById('comparisonContent').innerHTML = '<p>üìä Nenhum registro anterior para compara√ß√£o.</p>';
    return;
  }
  const mediaBruto = anteriores.reduce((sum, h) => sum + h.bruto, 0) / anteriores.length;
  const mediaDescontos = anteriores.reduce((sum, h) => sum + h.descontos, 0) / anteriores.length;
  const mediaLiquido = anteriores.reduce((sum, h) => sum + h.liquido, 0) / anteriores.length;

  document.getElementById('comparisonContent').innerHTML = `
    <div class="comparison-grid">
      <div class="comparison-card">
        <div class="comparison-label">Bruto Atual vs M√©dia</div>
        <div class="comparison-value" style="color: ${bruto > mediaBruto ? 'var(--success)' : 'var(--danger)'};">
          R$ ${formatMoney(bruto)}
        </div>
        <div style="font-size: 0.9rem; margin-top: 8px;">M√©dia: R$ ${formatMoney(mediaBruto)}</div>
      </div>
      <div class="comparison-card">
        <div class="comparison-label">Descontos Atual vs M√©dia</div>
        <div class="comparison-value" style="color: ${descontos > mediaDescontos ? 'var(--danger)' : 'var(--success)'};">
          R$ ${formatMoney(descontos)}
        </div>
        <div style="font-size: 0.9rem; margin-top: 8px;">M√©dia: R$ ${formatMoney(mediaDescontos)}</div>
      </div>
      <div class="comparison-card">
        <div class="comparison-label">L√≠quido Atual vs M√©dia</div>
        <div class="comparison-value" style="color: ${liquido > mediaLiquido ? 'var(--success)' : 'var(--danger)'};">
          R$ ${formatMoney(liquido)}
        </div>
        <div style="font-size: 0.9rem; margin-top: 8px;">M√©dia: R$ ${formatMoney(mediaLiquido)}</div>
      </div>
    </div>
  `;
}

function renderSimulation() {
  document.getElementById('simulationControls').innerHTML = `
    <div class="slider-group">
      <label class="slider-label">
        Aumento de Bruto (%)
        <span class="slider-value" id="simBrutoValue">0%</span>
      </label>
      <input type="range" min="-10" max="30" step="1" value="0" id="simBrutoSlider" oninput="atualizarSimulacao()">
    </div>
    <div class="slider-group">
      <label class="slider-label">
        Redu√ß√£o de Descontos (%)
        <span class="slider-value" id="simDescValue">0%</span>
      </label>
      <input type="range" min="0" max="50" step="1" value="0" id="simDescSlider" oninput="atualizarSimulacao()">
    </div>
  `;
  atualizarSimulacao();
}

function atualizarSimulacao() {
  const brutoPerc = parseFloat(document.getElementById('simBrutoSlider').value) / 100;
  const descPerc = parseFloat(document.getElementById('simDescSlider').value) / 100;
  document.getElementById('simBrutoValue').textContent = `${(brutoPerc * 100).toFixed(0)}%`;
  document.getElementById('simDescValue').textContent = `${(descPerc * 100).toFixed(0)}%`;

  const novoBruto = dados.bruto * (1 + brutoPerc);
  const novoDesconto = dados.totalDescontos * (1 - descPerc);
  const novoLiquido = novoBruto - novoDesconto;

  document.getElementById('simulationResults').innerHTML = `
    <div class="alert alert-info" style="margin-top: 20px;">
      <strong>Resultado da Simula√ß√£o:</strong><br>
      Novo Bruto: R$ ${formatMoney(novoBruto)}<br>
      Novos Descontos: R$ ${formatMoney(novoDesconto)}<br>
      <strong style="font-size: 1.2rem; color: var(--primary);">Novo L√≠quido: R$ ${formatMoney(novoLiquido)}</strong>
    </div>
  `;
}

function generateInsights(percDescontos, percLiquido) {
  const insights = [];
  if (percDescontos > 35) {
    insights.push('‚ö†Ô∏è Sua taxa de desconto est√° acima de 35%. Considere renegociar empr√©stimos ou revisar benef√≠cios.');
  } else if (percDescontos > 25) {
    insights.push('üí° Sua taxa de desconto est√° moderada. Fique atento a novos compromissos financeiros.');
  } else {
    insights.push('‚úÖ Excelente! Sua taxa de desconto est√° baixa. Voc√™ tem boa margem para investir ou poupar.');
  }

  if (dados.emprestimos && dados.emprestimos.length > 0) {
    const totalEmprestimos = dados.emprestimos.reduce((sum, e) => sum + e.valor, 0);
    const percEmprestimos = (totalEmprestimos / dados.bruto * 100).toFixed(1);
    insights.push(`üè¶ Empr√©stimos consignados representam ${percEmprestimos}% do seu bruto. Avalie se vale a pena quit√°-los antecipadamente.`);
  }

  if (percLiquido > 75) {
    insights.push('üìà Seu l√≠quido representa mais de 75% do bruto ‚Äì √≥timo momento para planejar investimentos!');
  }

  document.getElementById('insightsContent').innerHTML = insights.map(i => `<div class="insight-item"><div class="insight-text">${i}</div></div>`).join('');
}

function showAlert(message, type = 'info') {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type}`;
  alertDiv.innerHTML = message;
  document.body.appendChild(alertDiv);
  setTimeout(() => {
    if (alertDiv.parentNode) alertDiv.parentNode.removeChild(alertDiv);
  }, 5000);
}

function exportarRelatorio() {
  showAlert('üñ®Ô∏è Fun√ß√£o de exporta√ß√£o em PDF ser√° implementada via backend ou biblioteca como jsPDF.', 'info');
}

function resetar() {
  document.getElementById('arquivo').value = '';
  document.getElementById('textoColado').value = '';
  document.getElementById('mesAnoReferencia').value = '';
  document.getElementById('mesAnoManual').value = '';
  document.getElementById('totalBrutoManual').value = '';
  document.getElementById('totalDescontosManual').value = '';
  document.getElementById('totalLiquidoManual').value = '';
  document.getElementById('resultsContainer').classList.remove('active');
  updateSyncStatus('', '‚è≥ Aguardando dados...');
}
// TEMA CLARO/ESCURO
function toggleTheme() {
  const html = document.documentElement;
  const currentTheme = html.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  const icon = document.getElementById('themeToggle');
  
  html.setAttribute('data-theme', newTheme);
  icon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('theme', newTheme);
}

// Carregar tema salvo
function loadTheme() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.getElementById('themeToggle').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}

// Executar ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', loadTheme);

</script>
</html>
